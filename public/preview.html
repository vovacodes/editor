<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Preview</title>
    <script
      src="https://unpkg.com/react@16/umd/react.development.js"
      crossorigin
    ></script>
    <script
      src="https://unpkg.com/react-dom@16/umd/react-dom.development.js"
      crossorigin
    ></script>
  </head>
  <body>
    <div id="preview"></div>
    <script type="module">
      import * as Comlink from "https://unpkg.com/comlink/dist/esm/comlink.mjs";

      window.addEventListener("message", ev => {
        if (ev.data !== "init") return;

        const portToParent = ev.ports[0];
        portToParent.start();
        portToParent.postMessage("ready");
        Comlink.expose({ render }, portToParent);
      });

      async function render(meta, codeArrayBuffer, hash, timestamp) {
        console.log("preview: received code %dms", Date.now() - timestamp);
        const blob = new Blob([codeArrayBuffer], {
          type: "text/javascript;charset=utf-8"
        });
        const url = URL.createObjectURL(blob);
        try {
          const mod = await import(url);
          console.log(
            "preview: code evaluated %c%dms",
            "color: yellow",
            Date.now() - timestamp
          );
          // first exported component
          const component = mod[Object.keys(meta.componentsBySpecifier)[0]];
          ReactDOM.render(
            React.createElement(
              Preview,
              { key: hash },
              React.createElement(component)
            ),
            document.getElementById("preview")
          );
        } catch (err) {
          console.log("err, took:", Date.now() - timestamp);
          console.log({ err });
        }
      }

      class Preview extends React.Component {
        constructor(props) {
          super(props);
          this.state = { error: undefined };
        }

        static getDerivedStateFromError(error) {
          return { error };
        }

        componentDidCatch(error, errorInfo) {
          console.warn("Preview error: ", error, errorInfo);
        }

        render() {
          const error = this.props.error || this.state.error;
          console.log({
            stateError: this.state.error,
            propsError: this.props.error
          });

          if (error) {
            return React.createElement(
              "code",
              { style: { fontSize: 13, whiteSpace: "pre-wrap" } },
              error.toString()
            );
          }

          return this.props.children ?? null;
        }
      }
    </script>
  </body>
</html>
